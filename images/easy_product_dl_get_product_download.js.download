(function() {

    // -- BEGIN UTILITY FUNCTIONS -- //
    var simulateClick = function (elem) {
        // Create our event (with options)
        var evt = new MouseEvent('click', {
            bubbles: true,
            cancelable: true,
            view: window
        });
        // If cancelled, don't dispatch our event
        var canceled = !elem.dispatchEvent(evt);
    };

    function validURL(url) {
        return /^(https?|s?ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(url);
    }

    function textContains(selector, text) {
        var elements = document.querySelectorAll(selector);
        return Array.prototype.filter.call(elements, function(element){
          if(RegExp(text).test(element.textContent)) {
              return element;
          }
        });
    }

    function linkify(inputText) {

        if (inputText.includes("</a>")) {

            return inputText;

        } else {

            var replacedText, replacePattern1, replacePattern2, replacePattern3;

            //URLs starting with http://, https://, or ftp://
            replacePattern1 = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
            replacedText = inputText.replace(replacePattern1, '<a href="$1" target="_blank">$1</a>');

            //URLs starting with "www." (without // before it, or it'd re-link the ones done above).
            replacePattern2 = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
            replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" target="_blank">$2</a>');

            //Change email addresses to mailto:: links.
            replacePattern3 = /(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;
            replacedText = replacedText.replace(replacePattern3, '<a href="mailto:$1">$1</a>');

            return replacedText;

        }
    }
    // -- END UTILITY FUNCTIONS -- //

    var shopify_details = window.Shopify;

    if (shopify_details && shopify_details.Checkout && (shopify_details.Checkout.isOrderStatusPage || (shopify_details.Checkout.page && (shopify_details.Checkout.page == "thank_you" || shopify_details.Checkout.page == "checkout_one_thank_you")))) {

        /*
        var pusher_js = document.createElement('script');
        pusher_js.src = '//js.pusher.com/7.4.0/pusher.min.js';
        document.head.appendChild(pusher_js);
        */

    }

    if (document.readyState !== 'loading') {
        launchEdpScripts();
    } else {
        document.addEventListener('DOMContentLoaded', function () {
            launchEdpScripts();
        });
    }

    function launchEdpScripts() {

        var shopify_infos = window.Shopify;
        var shopify_store = shopify_infos.shop;
        var files_linked_array = [];

        // Check if we are on the order_confirmation page
        if (shopify_infos && shopify_infos.Checkout && (shopify_infos.Checkout.isOrderStatusPage || (shopify_infos.Checkout.page && (shopify_infos.Checkout.page == "thank_you" || shopify_infos.Checkout.page == "checkout_one_thank_you")))) {

            var order_id = "-";
            var order_name = "-";

            if (shopify_infos.checkout && shopify_infos.checkout.order_id) {
                order_id = shopify_infos.checkout.order_id;
            }
            // Sometimes we don't have access to the checkout object or order_id directly... Let's find the order name
            else {

                if (document.querySelector(".os-order-number").length) {

                    var order_name_container = document.querySelector(".os-order-number").html().trim();
                    var order_txt_array = order_name_container.split(" ");
                    var order_name = order_txt_array.pop();

                    order_name = order_name.replace("#", '');

                }

            }

            var edp_popup_dom = document.createElement('div');
            edp_popup_dom.innerHTML = '\
            <div>\
                <svg display="none" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="768" height="800" viewBox="0 0 768 800"><defs><g id="edp-icon-close"><path class="path1" d="M31.708 25.708c-0-0-0-0-0-0l-9.708-9.708 9.708-9.708c0-0 0-0 0-0 0.105-0.105 0.18-0.227 0.229-0.357 0.133-0.356 0.057-0.771-0.229-1.057l-4.586-4.586c-0.286-0.286-0.702-0.361-1.057-0.229-0.13 0.048-0.252 0.124-0.357 0.228 0 0-0 0-0 0l-9.708 9.708-9.708-9.708c-0-0-0-0-0-0-0.105-0.104-0.227-0.18-0.357-0.228-0.356-0.133-0.771-0.057-1.057 0.229l-4.586 4.586c-0.286 0.286-0.361 0.702-0.229 1.057 0.049 0.13 0.124 0.252 0.229 0.357 0 0 0 0 0 0l9.708 9.708-9.708 9.708c-0 0-0 0-0 0-0.104 0.105-0.18 0.227-0.229 0.357-0.133 0.355-0.057 0.771 0.229 1.057l4.586 4.586c0.286 0.286 0.702 0.361 1.057 0.229 0.13-0.049 0.252-0.124 0.357-0.229 0-0 0-0 0-0l9.708-9.708 9.708 9.708c0 0 0 0 0 0 0.105 0.105 0.227 0.18 0.357 0.229 0.356 0.133 0.771 0.057 1.057-0.229l4.586-4.586c0.286-0.286 0.362-0.702 0.229-1.057-0.049-0.13-0.124-0.252-0.229-0.357z"></path></g></defs></svg>\
                <div class="edp-modal">\
                    <div class="edp-modal-overlay edp-modal-toggle"></div>\
                    <div class="edp-modal-wrapper edp-modal-transition">\
                        <button class="edp-modal-close edp-modal-toggle">\
                            <svg class="edp-icon-close edp-icon" viewBox="0 0 32 32">\
                            <use xlink:href="#edp-icon-close"></use>\
                            </svg>\
                        </button>\
                        <div class="edp-modal-body">\
                            <div class="edp-modal-content">\
                            </div>\
                        </div>\
                    </div>\
                </div>\
            </div>';

            // Add the modal popup HTML
            document.body.appendChild(edp_popup_dom);

            // Add the loading spinner CSS
            var edp_styles = "\
            blockquote {\
                position: relative;\
                margin: 0;\
                padding: .5rem;\
                border: 1px solid #e9e9e9;\
                font-style: italic;\
                padding-left: 20px;\
                padding-right: 20px;\
                background: #f6f6f7;\
                border-radius: 7px;\
                text-align: center;\
                margin: auto;\
                display: block;\
            }\
            cite {\
                line-height: 3;\
                text-align: left;\
            }\
            .lds-dual-ring {\
                display: inline-block;\
                width: 100%;\
                text-align: center;\
                height: 80px;\
                left: 50%;\
                transform: translate(-50%, 0);\
                position: absolute;\
                top: 10%;\
            }\
            .lds-dual-ring:after {\
                content: ' ';\
                display: block;\
                width: 64px;\
                height: 64px;\
                margin: auto;\
                border-radius: 50%;\
                border: 6px solid #545454;\
                border-color: #545454 transparent #545454 transparent;\
                animation: lds-dual-ring 1.2s linear infinite;\
            }\
            .edp-icon {\
                display: inline-block;\
                width: 11px;\
                height: 11px;\
                vertical-align: middle;\
                fill: currentcolor;\
            }\
            .edp-modal {\
                position: absolute;\
                z-index: 10000;\
                top: 0;\
                left: 0;\
                visibility: hidden;\
                width: 100%;\
                height: 100%;\
            }\
            .edp-modal.is-visible {\
                visibility: visible;\
            }\
            .edp-modal-overlay {\
                position: fixed;\
                z-index: 10;\
                top: 0;\
                left: 0;\
                width: 100%;\
                height: 100%;\
                background: hsla(0, 0%, 0%, 0.5);\
                visibility: hidden;\
                opacity: 0;\
                transition: visibility 0s linear 0.3s, opacity 0.3s;\
            }\
            .edp-modal.is-visible .edp-modal-overlay {\
                opacity: 1;\
                visibility: visible;\
                transition-delay: 0s;\
            }\
            .edp-modal .btn {\
                display: inline-block;\
            }\
            .edp-modal .btn span {\
                display: inline-block;\
            }\
            .edp-modal-wrapper {\
                position: absolute;\
                z-index: 9999;\
                top: 6em;\
                left: 50%;\
                width: 50%;\
                margin-left: -25%;\
                background-color: #fff;\
                box-shadow: 0 0 1.5em hsla(0, 0%, 0%, 0.35);\
                border-radius: 8px;\
            }\
            .edp-modal-transition {\
                transition: all 0.3s 0.12s;\
                transform: translateY(-10%);\
                opacity: 0;\
            }\
            .edp-modal.is-visible .edp-modal-transition {\
                transform: translateY(0);\
                opacity: 1;\
            }\
            .edp-modal-header,\
            .edp-modal-content {\
                padding: 1em;\
            }\
            .edp-modal-header {\
                position: relative;\
                background-color: #fff;\
                padding: 0px;\
            }\
            .edp-modal-close {\
                position: absolute;\
                top: -11px;\
                right: -10px;\
                background: #333;\
                padding: 7px;\
                color: #FFF;\
                line-height: 0;\
                border-radius: 100%;\
            }\
            .edp-modal-close:hover {\
                color: #777;\
            }\
            .edp-modal-heading {\
                font-size: 1.125em;\
                margin: 0;\
                -webkit-font-smoothing: antialiased;\
                -moz-osx-font-smoothing: grayscale;\
            }\
            .edp-modal-content > *:first-child {\
                margin-top: 0;\
            }\
            .edp-modal-content > *:last-child {\
                margin-bottom: 0;\
            }\
            .edp-modal table {\
                border-collapse: collapse;\
                background: white;\
                border-radius: 10px;\
                overflow: hidden;\
                width: 100%;\
                margin: 0 auto;\
                position: relative;\
            }\
            .edp-modal tr {\
                font-size: 15px;\
                color: #333333;\
                line-height: 1.2;\
                font-weight: unset;\
                height: 50px;\
                background: #e8e8e8;\
            }\
            .edp-modal td {\
                padding-left: 15px;\
                padding-right: 15px;\
                padding-top: 10px;\
                padding-bottom: 10px;\
            }\
            .edp-modal tr:nth-child(even) {\
                background-color: #f5f5f5;\
            }\
            .btn-act-download-multiple-modal.loading span {\
                visibility: hidden;\
                opacity: 0;\
            }\
            .btn-act-download-multiple-modal.loading::after {\
                content: '';\
                position: absolute;\
                width: 12px;\
                height: 12px;\
                top: 0;\
                left: 0;\
                right: 0;\
                bottom: 0;\
                margin: auto;\
                border: 4px solid transparent;\
                border-top-color: #ffffff;\
                border-radius: 50%;\
                animation: button-loading-spinner 1s ease infinite;\
            }\
            @media(max-width: 1090px) {\
                .edp-modal-wrapper {\
                    top: 20px;\
                    left: 50%;\
                    width: 90%;\
                    margin-left: -45%;\
                    }\
                    .edp-modal td {\
                        width: 50% !important;\
                    }\
            }\
            @keyframes button-loading-spinner {\
                from {\
                    transform: rotate(0turn);\
                }\
                to {\
                    transform: rotate(1turn);\
                }\
            }\
            @keyframes lds-dual-ring {\
                0% {\
                    transform: rotate(0deg);\
                }\
                100% {\
                    transform: rotate(360deg);\
                }\
            }\
            @keyframes fadeIn {\
                0% { opacity: 0; }\
                100% { opacity: 1; }\
            }\
            @keyframes fadeOut {\
                0% { opacity: 1; }\
                100% { opacity: 0; }\
            }";

            document.head.insertAdjacentHTML("beforeend", "<style>" + edp_styles + "</style>");

            var edp_loading_dom = document.createElement('div');
            edp_loading_dom.innerHTML = "\
            <div style='opacity: 0;animation: fadeIn 0.5s;height: 100%; position: absolute; top: 0; bottom: 0; left: 0px; right: -20px; z-index: 9999; background: rgba(255,255,255,0.7);' class='edp_loading_state'>\
                <div class='lds-dual-ring'>\
                    <span style='opacity: 0;margin-bottom: 10px; position: absolute; margin: auto; width: 80%; font-weight: 500; padding-left: 20px; padding-right: 20px; padding-top: 10px; padding-bottom: 10px; font-family: Roboto, Helvetica, Arial, sans-serif; background-color: rgba(50,50,50,0.85); border-radius: 2em; color: #FFF;margin-left: auto; margin-right: auto; left: 0; right: 0; text-align: center; margin-top: 95px;' class='edp-loading-state'></span>\
                </div>\
            </div>";

            document.querySelector(".sidebar").appendChild(edp_loading_dom);

            var edp_loading_state = document.querySelector(".edp_loading_state");
            edp_loading_state.style.opacity = "1";

            let get_edp_details_options = {
                method: 'GET',      
                headers: {}
            };

            fetch("/apps/edigital-products/get_edp_details/" + order_id + "/" + order_name, get_edp_details_options)
            .then(response => response.json())
            .then(data => {

                if (data.edp_show_queue_txt == 1) {

                    hide_edp_loading_state();

                    var product_table = document.querySelector(".product-table");
                    var custom_order_msg_dom = document.createElement('div');

                    var custom_order_msg = "";
                    custom_order_msg += "<div style='border: 1px solid #b8daff; margin-top: 14px; postion: relative; color: #004085; background-color: #cce5ff; border-color: #b8daff; text-align: center; position: relative; padding: 1.1rem 1.15rem; line-height: 16px; margin-bottom: 26px; border: 1px solid #b8daff; border-radius: .25rem;'>";
                    custom_order_msg += "<div style='position: absolute; left: 11px; top: -11px; background: #cce5ff; font-weight: bold; text-transform: uppercase; line-height: 17px; font-size: 10px; padding-left: 10px; padding-right: 10px; border-radius: 7px; padding-top: 0px; border: 1px solid #b8daff;'>IMPORTANT</div><div style=''>" + data.order_queued_txt + "</div></div>";
                    custom_order_msg += "</div>";

                    custom_order_msg_dom.innerHTML = custom_order_msg;
                    product_table.before(custom_order_msg_dom);

                } else {

                    // We have at least one digital product in the order
                    if (data.edp_products == 1) {

                        if (data.order_generating_txt) {
                            document.querySelector(".edp_loading_state > div > span").innerHTML = data.order_generating_txt;
                            document.querySelector(".edp_loading_state > div > span").style.animation = "fadeIn 0.5s";
                            document.querySelector(".edp_loading_state > div > span").style.opacity = "1";
                        }

                        /*
                        // Call pusher in case the order is processing
                        if (typeof Pusher !== "undefined") {

                            var pusher = new Pusher('ee620c54db7d2a0a0bb0', {
                                channelAuthorization: {
                                    transport: "jsonp",
                                    endpoint: "/apps/edigital-products/pusher_user_auth"
                                }
                            });

                            var channel = pusher.subscribe('private-order-confirmation-channel-' + order_id + "-" + data.shop_id);

                        }
                        */

                        let get_download_options = {
                            method: 'GET',      
                            headers: {}
                        };

                        // Now we can execute the digital order checking
                        fetch("/apps/edigital-products/get_download/" + order_id + "/" + order_name, get_download_options)
                        .then(response => response.json())
                        .then(data => {

                            if (data.order_status && data.order_status == "order_being_processed") {

                                var edp_loading_state = document.querySelector(".edp_loading_state");
                                edp_loading_state.innerHTML = "Your digital order is being processed and will be sent soon to your email...";

                            } else {

                                generate_digital_order_view(data);

                            }

                            /*
                            if (data.order_status && data.order_status == "order_being_processed" && channel) {

                                // If the digital order is being processed, we listen to the data with pusher
                                channel.bind('digital-order-event', function(pusher_data) {

                                    if (pusher_data.message) {


                                        if (pusher) {

                                            // We can disconnect because we already got our result
                                            pusher.disconnect();

                                        }

                                        if (pusher_data.message == 1) {

                                            var edp_loading_state = document.querySelector(".edp_loading_state");
                                            edp_loading_state.innerHTML = "Reloading page to get your downloads...";

                                            window.location.reload();

                                        }

                                    }

                                });

                            } else {

                                if (pusher) {

                                    // We can disconnect because we already got our result
                                    pusher.disconnect();

                                }

                                generate_digital_order_view(data);

                            }
                            */

                        }).catch(function(error) {

                            console.log(error);
                            hide_edp_loading_state();

                        });

                    } else {

                        if(data.error && data.error == "too_many_items_in_order_fulfill_from_webhook") {

                            var product_table = document.querySelector(".product-table");
                            var custom_order_msg_dom = document.createElement('div');

                            var custom_order_msg = "";
                            custom_order_msg += "<div style='border: 1px solid #b8daff; margin-top: 14px; postion: relative; color: #004085; background-color: #cce5ff; border-color: #b8daff; text-align: center; position: relative; padding: 1.1rem 1.15rem; line-height: 16px; margin-bottom: 26px; border: 1px solid #b8daff; border-radius: .25rem;'>";
                            custom_order_msg += "<div style='position: absolute; left: 11px; top: -11px; background: #cce5ff; font-weight: bold; text-transform: uppercase; line-height: 17px; font-size: 10px; padding-left: 10px; padding-right: 10px; border-radius: 7px; padding-top: 0px; border: 1px solid #b8daff;'>IMPORTANT</div><div style=''>Your digital content (downloads and or keys) has been sent to you by email (or will be sent in the next few minutes).</div></div>";
                            custom_order_msg += "</div>";

                            custom_order_msg_dom.innerHTML = custom_order_msg;
                            product_table.before(custom_order_msg_dom);

                        }

                        hide_edp_loading_state();

                    }

                }

            }).catch(function() {

                hide_edp_loading_state();

                var product_table = document.querySelector(".product-table");
                var custom_order_msg_dom = document.createElement('div');

                var custom_order_msg = "";
                custom_order_msg += "<div style='border: 1px solid #b8daff; margin-top: 14px; postion: relative; color: #004085; background-color: #cce5ff; border-color: #b8daff; text-align: center; position: relative; padding: 1.1rem 1.15rem; line-height: 16px; margin-bottom: 26px; border: 1px solid #b8daff; border-radius: .25rem;'>";
                custom_order_msg += "<div style='position: absolute; left: 11px; top: -11px; background: #cce5ff; font-weight: bold; text-transform: uppercase; line-height: 17px; font-size: 10px; padding-left: 10px; padding-right: 10px; border-radius: 7px; padding-top: 0px; border: 1px solid #b8daff;'>IMPORTANT</div><div style=''>If your order contains digital content (downloads and / or license keys), this digital content will be sent to your email in the next few minutes.</div></div>";
                custom_order_msg += "</div>";

                custom_order_msg_dom.innerHTML = custom_order_msg;
                product_table.before(custom_order_msg_dom);

            });

        }
        // Check if we are on the "my account" page
        else if (onMyAccountPage()) {

            if (__st && __st.cid) {

                var customer_id = __st.cid;

                let check_show_download_button_history_options = {
                    method: 'GET',      
                    headers: {}
                };

                // Now we can execute the digital order checking
                fetch("/apps/edigital-products/check_show_download_button_history", check_show_download_button_history_options)
                .then(response => response.json())
                .then(data => {

                    var button_orders_history_css_class = "";

                    if (data.button_orders_history_css_class) {
                        button_orders_history_css_class = data.button_orders_history_css_class;
                    }

                    if (data.status == 1) {

                        if (!localStorage.edp_digital_orders) {

                            let get_customers_digital_orders_options = {
                                method: 'GET',      
                                headers: {}
                            };
            
                            // Now we can execute the digital order checking
                            fetch("/apps/edigital-products/get_customers_digital_orders/" + customer_id, get_customers_digital_orders_options)
                            .then(response => response.json())
                            .then(data => {

                                localStorage.setItem("edp_digital_orders", JSON.stringify(data.digital_orders));
                                showOrdersHistoryDownloadButtons(data.digital_orders, button_orders_history_css_class);
                                
                            });

                        } else {

                            var edp_digital_orders = JSON.parse(localStorage.getItem("edp_digital_orders") || "[]");
                            showOrdersHistoryDownloadButtons(edp_digital_orders, button_orders_history_css_class);

                        }

                    }

                });

            }

        }

        document.addEventListener("click", function(e) {

            const btn_open_modal_downloads = e.target.closest(".btn-open-modal-downloads");
            if(btn_open_modal_downloads) {

                e.preventDefault();

                var that_style = btn_open_modal_downloads.getAttribute("style");
                var that_txt = btn_open_modal_downloads.innerHTML;
                var product_file_id = btn_open_modal_downloads.getAttribute("data-product-file-id");
                var files_linked = files_linked_array[product_file_id];
                var order_id = btn_open_modal_downloads.getAttribute("data-order-id");
                var limit_reached_text = btn_open_modal_downloads.getAttribute("data-limit-reached-text");
    
                var modal_content = "<table>";

                for (var file of files_linked) {

                    modal_content += "<tr>";
                    modal_content += "<td style='width: 70%;'>" + /[^/]*$/.exec(file.filename)[0] + "</td>";
                    modal_content += "<td><a href='#' style='" + that_style + ";margin-top:10px;margin-bottom: 10px;' class='btn btn-act-download-multiple-modal edp-btn-modal-download' data-limit-reached-text='" + limit_reached_text + "' data-product-file-id='" + file.id + "' data-product-id='" + file.product_id + "' data-variant-id='" + file.variant_id + "' data-order-id='" + order_id + "'><span>" + that_txt + "</span></a></td>";
                    modal_content += "</tr>";

                }

                modal_content += "</table>";

                var edp_modal_content = document.querySelector(".edp-modal .edp-modal-content");
                edp_modal_content.innerHTML = modal_content;

                var edp_modal = document.querySelector(".edp-modal");
                edp_modal.classList.toggle('is-visible');

            }


            const btn_edp_modal_toggle = e.target.closest(".edp-modal-toggle");
            if(btn_edp_modal_toggle) {

                e.preventDefault();

                var edp_modal = document.querySelector(".edp-modal");
                edp_modal.classList.toggle('is-visible');

            }


            const btn_act_download_multiple_modal = e.target.closest(".btn-act-download-multiple-modal"); 
            if(btn_act_download_multiple_modal) {

                e.preventDefault();

                var product_file_id = btn_act_download_multiple_modal.getAttribute("data-product-file-id");
                var product_id = btn_act_download_multiple_modal.getAttribute("data-product-id");
                var variant_id = btn_act_download_multiple_modal.getAttribute("data-variant-id");
                var order_id = btn_act_download_multiple_modal.getAttribute("data-order-id");
                var limit_reached_text = btn_act_download_multiple_modal.getAttribute("data-limit-reached-text");

                btn_act_download_multiple_modal.style.pointerEvents = "none";
                btn_act_download_multiple_modal.classList.add("loading");

                let get_download_options = {
                    method: 'GET',      
                    headers: {}
                };

                // Now we can execute the digital order checking
                fetch("/apps/edigital-products/direct_download_multiple_modal/" + product_file_id + "/" + order_id + "/" + product_id + "/" + variant_id, get_download_options)
                .then(response => response.json())
                .then(data => {

                    btn_act_download_multiple_modal.classList.remove("loading");

                    if (data.success) {

                        btn_act_download_multiple_modal.style.pointerEvents = "auto";
                        window.location = data.download_url;

                    } else if (data.error) {

                        if (data.error == "download_count_reached" || data.error == "download_time_reached") {

                            btn_act_download_multiple_modal.style.background = "#CCC";
                            btn_act_download_multiple_modal.style.color = "#000";
                            btn_act_download_multiple_modal.style.cursor = "not-allowed";
                            btn_act_download_multiple_modal.style.opacity = 0.6;
                            btn_act_download_multiple_modal.innerHTML = limit_reached_text;

                        } else {

                            var edp_modal_content = document.querySelector(".edp-modal-content");
                            edp_modal_content.insertAdjacentHTML("afterbegin", "<p style='text-align:center; color: #e74c3c; margin-bottom: 20px;'>" + data.error + "</p>");

                        }

                    }

                });

            }


            const btn_act_download = e.target.closest(".btn-act-download"); 
            if(btn_act_download) {

                btn_act_download.style.pointerEvents = "none";

                // Disable the click on the button for 10 seconds
                setTimeout(function() {

                    btn_act_download.style.pointerEvents = "auto";

                }, 10000);

                var current_download_count = btn_act_download.getAttribute("data-current-downloads");
                var max_download_count = btn_act_download.getAttribute("data-max-downloads");

                var new_current_download_count = parseInt(current_download_count) + 1;
                btn_act_download.setAttribute("data-current-downloads", new_current_download_count);

                if (new_current_download_count == max_download_count && max_download_count != 0) {

                    var limit_reached_text = btn_act_download.getAttribute("data-limit-reached-text");

                    btn_act_download.innerHTML = limit_reached_text;
                    btn_act_download.style.background = "#CCC";
                    btn_act_download.style.cursor = "not-allowed";

                }

            }

        });

        
        function showOrdersHistoryDownloadButtons(digital_orders, button_orders_history_css_class = "") {

            if (Object.keys(digital_orders).length > 0) {
                
                var download_btn_style = "padding-top: 6px; font-size: 12px; padding-bottom: 6px; padding-left: 11px; padding-right: 11px; width: 100%; background: #333 !important; color: #FFF !important; display: block; text-align: center; font-weight: bold; line-height: 13px; margin-top: 3px";

                for (var d_order of Object.keys(digital_orders)) {

                    var order_link = textContains('td', d_order);

                    if (order_link.length == 0) {

                        var order_link = textContains('th', d_order);

                    }

                    // Still not found? Maybe it's a link
                    if (order_link.length == 0) {

                        var order_link = textContains('a', d_order);

                    }

                    if (order_link.length > 0) {

                        order_link[0].insertAdjacentHTML('beforeend', '<a href="' + digital_orders[d_order] + '" class="edp_download_btn ' + button_orders_history_css_class + '" style="' + download_btn_style + '" aria-label="">Downloads</a>');

                    }
                }

            }

        }

        
        function hide_edp_loading_state() {

            var edp_loading_state = document.querySelector(".edp_loading_state");

            if(edp_loading_state) {

                edp_loading_state.style.animation = "fadeOut 0.5s";
                edp_loading_state.style.opacity = "0";

                setTimeout(function() {

                    edp_loading_state.remove();

                }, 1000);

            }
        
        }

        function generate_digital_order_view(data) {

            hide_edp_loading_state();                
            
            var order_summary_section_content_dom = document.querySelector(".order-summary__section__content");

            if (data.order_not_found) {

                order_summary_section_content_dom.insertAdjacentHTML("afterbegin", "<div style='font-size: 10px; line-height: 1.3; padding-top: 4px; padding-bottom: 3px; text-align: center; font-weight: 500; background-color: #FEAF9A; color: #330101; padding-left: 6px; padding-right: 6px; border-radius: 4px; text-transform: uppercase; vertical-align: 1px; margin-bottom: 17px;'>Your downloads will be ready soon. Please refresh this page in a few seconds to see your download links.</div>");

            } else if (data.has_download) {

                if (data.has_download == 1) {

                    // Erase the orders history for this customer
                    if (localStorage.edp_digital_orders && data.new_download == 1) {

                        localStorage.removeItem("edp_digital_orders");

                    }

                    var product_table_tbody_dom = document.querySelector(".product-table tbody");

                    // Is it a new download?
                    if (data.new_download == 1) {

                        product_table_tbody_dom.classList.add("edp-status-new-download");

                    } else {

                        product_table_tbody_dom.classList.add("edp-status-old-download");

                    }

                    // Redesign the products list
                    var trs_product_dom = document.querySelectorAll("tr.product");
                    for (var p_i = 0; p_i < trs_product_dom.length; p_i++) {

                        if(p_i < trs_product_dom.length - 1) {

                            trs_product_dom[p_i].insertAdjacentHTML('afterEnd', "<tr><td colspan='6' style=''><div style='border-top: 1px solid rgba(175,175,175,0.34); margin-top: 18px; margin-bottom: 10px;'></div></td></tr>")

                        }
                        
                    }

                    // Set the style for the "scroll button" that can cause the download buttons to be disabled
                    var edp_styles_hide_scroll_indicator = '\
                    .order-summary__section--has-scroll .order-summary__scroll-indicator {\
                        display:none;\
                    }';

                    document.head.insertAdjacentHTML("beforeend", "<style>" + edp_styles_hide_scroll_indicator + "</style>");

                    // Append the custom CSS
                    if (data.custom_css && data.custom_css != "") {

                        document.head.insertAdjacentHTML("beforeend", "<style>" + data.custom_css + "</style>");

                    }

                    var product_files = data.product_files;
                    var array_variant_ids = data.array_variant_ids;

                    if (data.custom_order_text != "" && data.custom_order_text != null && product_files.length > 0) {

                        var custom_order_msg = "";

                        custom_order_msg += "<div style='border: 1px solid #b8daff; margin-top: 14px; postion: relative; color: #202223; background-color: #ebf9fc; border-color: #98c6cd; text-align: center; position: relative; padding: 1.1rem 1.15rem; line-height: 16px; margin-bottom: 19px; border: 1px solid #b8daff; border-radius: .25rem;'>";
                        custom_order_msg += "<div style=''>" + data.custom_order_text + "</div>";
                        custom_order_msg += "</div>";

                        var product_table_dom = document.querySelector(".product-table");
                        product_table_dom.insertAdjacentHTML("beforebegin", custom_order_msg);

                    }

                    var array_tr_lines = [];

                    for (var product_file of product_files) {

                        var product_id = product_file.product_id;
                        var variant_id = product_file.variant_id;
                        var tr_lines = [];
                        var file_extension = "";
                        var is_all_variants = false;

                        if (product_file.filename) {

                            file_extension = product_file.filename.split('.').pop();

                        }

                        // If we have a product variant specified
                        if (variant_id != 0) {

                            is_all_variants = false;

                            tr_lines = document.querySelectorAll("tr[data-product-id='" + product_id + "'][data-variant-id='" + variant_id + "']");
                            
                            for (var tr_lines_i = 0; tr_lines_i < tr_lines.length; tr_lines_i++) {
                                tr_lines[tr_lines_i].classList.add('edp_downloadable');
                            }

                        }
                        // If it's a 0 variant which means "All Variants", we need to determine the good tr line
                        else {

                            is_all_variants = true;

                            var product_id_trs = document.querySelectorAll("tr[data-product-id='" + product_id + "']");

                            for(var product_id_tr_i = 0; product_id_tr_i < product_id_trs.length; product_id_tr_i++) {

                                var product_id_tr = product_id_trs[product_id_tr_i];
                                var tr_variant_id = product_id_tr.getAttribute("data-variant-id");

                                if(array_variant_ids && array_variant_ids[product_id]) {
                                    
                                    if(!array_variant_ids[product_id].includes(tr_variant_id)) {

                                        if(!product_id_tr.classList.contains('edp_downloadable')) {
                                            product_id_tr.classList.add('edp_downloadable');

                                            tr_lines.push(product_id_tr);

                                            break;
                                        }

                                    }

                                }

                            }

                        }

                        var cur_license_key = "";

                        // The product line exists...
                        if (tr_lines.length > 0) {

                            var tr_product_id_variant_id = product_id + "_" + variant_id;

                            // Construct the array of TRs and define the good TR to append content to
                            if(!is_all_variants) {

                                if(typeof array_tr_lines[tr_product_id_variant_id] === 'undefined') {
                                    array_tr_lines[tr_product_id_variant_id] = 0;
                                    var tr_index_to_append = 0;
                                } else {
                                    array_tr_lines[tr_product_id_variant_id] = array_tr_lines[tr_product_id_variant_id]+1;
                                    var tr_index_to_append = array_tr_lines[tr_product_id_variant_id];
                                }

                            } else {

                                var tr_index_to_append = 0;

                            }

                            var order_summary_toggle_dom = document.querySelector(".order-summary-toggle");

                            // If we have the mobile / responsive view
                            if (order_summary_toggle_dom !== null) {

                                if(!order_summary_toggle_dom.classList.contains('toggle-opened')) {

                                    order_summary_toggle_dom.classList.add("toggle-opened");
                                    simulateClick(order_summary_toggle_dom);

                                }
                            }

                            order_summary_section_content_dom.style.cssText = 'height: 100% !important';
                            var download_btn_style = '';

                            if (product_file.license_key) {

                                download_btn_style = "padding-top: 6px; font-size: 12px; padding-bottom: 6px; padding-left: 11px; padding-right: 11px; width: 100%;background: #" + data.btn_download_bg_color + "; color: #" + data.btn_download_text_color + ";";

                                if (product_file.license_key.length <= 1) {

                                    var cur_license_key = product_file.license_key[0];

                                    if (validURL(cur_license_key)) {
                                        cur_license_key = "<a target='_blank' href='" + cur_license_key + "'>" + cur_license_key + "</a>";
                                    }

                                    var license_key_line = "<tr><td class='edp-license-keys-list' style='padding-top: 5px;text-align:left;margin-bottom:10px;' colspan='6'>";
                                    license_key_line += "<b>" + data.btn_license_text + "</b> : ";

                                    if (cur_license_key == "edp_no_keys") {
                                        license_key_line += "<span style='font-size: 10px; min-height: 10px; line-height: 0.7; padding-top: 1px; padding-bottom: 2px; font-weight: 500; background-color: #FEAF9A; color: #330101; padding-left: 6px; padding-right: 6px; border-radius: 4px; text-transform: uppercase; vertical-align: 1px;'>" + data.license_keys_sent_soon_text + "</span><br>";
                                    } else {
                                        license_key_line += cur_license_key + "<br>";
                                    }

                                    license_key_line += "</td></tr>";
                                    
                                    tr_lines[tr_index_to_append].insertAdjacentHTML("afterend", license_key_line);

                                } else {

                                    var license_key_line = "<tr><td class='edp-license-keys-list' style='padding-top: 5px;text-align:left;margin-bottom:10px;' colspan='6'>";

                                    // Deliver more than one key per product (multi-quantity product)
                                    for (var q = 0; q < product_file.license_key.length; q++) {

                                        var license_id = q + 1;
                                        var cur_license_key = product_file.license_key[q];

                                        if (validURL(cur_license_key)) {
                                            cur_license_key = "<a target='_blank' href='" + cur_license_key + "'>" + cur_license_key + "</a>";
                                        }

                                        if (cur_license_key == "edp_no_keys") {
                                            cur_license_key = "<span style='font-size: 10px; min-height: 10px; line-height: 0.7; padding-top: 1px; padding-bottom: 2px; font-weight: 500; background-color: #FEAF9A; color: #330101; padding-left: 6px; padding-right: 6px; border-radius: 4px; text-transform: uppercase; vertical-align: 1px;'>" + data.license_keys_sent_soon_text + "</span>";
                                        }

                                        license_key_line += "<b>" + data.btn_license_text + " #" + license_id + "</b> : " + cur_license_key + "<br>";

                                    }

                                    license_key_line += "</td></tr>";

                                    tr_lines[tr_index_to_append].insertAdjacentHTML("afterend", license_key_line);

                                }

                            } else {

                                download_btn_style = "margin-bottom: 20px;padding-top: 6px; font-size: 12px; padding-bottom: 6px; padding-left: 11px; padding-right: 11px; width: 100%; background: #" + data.btn_download_bg_color + "; color: #" + data.btn_download_text_color + ";";

                            }


                            if (product_file.added_method != "no_file") {

                                if (product_file.download_limit_reached) {

                                    var download_disabled_btn_style = "background: #CCC;cursor: not-allowed;";

                                    tr_lines[tr_index_to_append].insertAdjacentHTML("afterend", "<tr><td style='padding-top: 5px;text-align:left;' colspan='6'><a class='btn' href='#' style='" + download_btn_style + ";opacity:0.5;" + download_disabled_btn_style + "' data-max-downloads='" + product_file.max_download_count + "' data-current-downloads='" + product_file.current_download_count + "'>" + data.btn_download_limit_reached_text + "</a></td></tr>");

                                } else if (product_file.download_limit_time_reached) {

                                    var download_disabled_btn_style = "background: #CCC;cursor: not-allowed;";

                                    tr_lines[tr_index_to_append].insertAdjacentHTML("afterend", "<tr><td style='padding-top: 5px;text-align:left;' colspan='6'><a class='btn' href='#' style='" + download_btn_style + ";opacity:0.5;" + download_disabled_btn_style + "' data-max-downloads='" + product_file.max_download_count + "' data-current-downloads='" + product_file.current_download_count + "'>" + data.btn_download_limit_time_reached_text + "</a></td></tr>");

                                } else {

                                    var download_url = product_file.download_url;

                                    if (data.btn_show_mode == 0) {

                                        if (product_file.added_method == "url") {
                                            tr_lines[tr_index_to_append].insertAdjacentHTML("afterend", "<tr><td style='padding-top: 5px;text-align:left;' colspan='6'><a class='btn btn-act-download edp-btn-download' target='_blank' href='" + download_url + "' style='" + download_btn_style + "' data-max-downloads='" + product_file.max_download_count + "' data-current-downloads='" + product_file.current_download_count + "' data-limit-reached-text='" + data.btn_download_limit_reached_text + "'>" + data.btn_download_text + "</a></td></tr>");
                                        } else {

                                            if (product_file.files_count_linked > 1) {
                                                files_linked_array[product_file.id] = product_file.files_linked;
                                                tr_lines[tr_index_to_append].insertAdjacentHTML("afterend", "<tr><td style='padding-top: 5px;text-align:left;' colspan='6'><a class='btn btn-open-modal-downloads edp-btn-download' target='_blank' href='" + download_url + "' style='" + download_btn_style + "' data-product-file-id='" + product_file.id + "' data-order-id='" + data.order_id + "' data-max-downloads='" + product_file.max_download_count + "' data-current-downloads='" + product_file.current_download_count + "' data-limit-reached-text='" + data.btn_download_limit_reached_text + "'>" + data.btn_download_text + "</a></td></tr>");
                                            } else {
                                                tr_lines[tr_index_to_append].insertAdjacentHTML("afterend", "<tr><td style='padding-top: 5px;text-align:left;' colspan='6'><a class='btn btn-act-download edp-btn-download' target='_blank' href='" + download_url + "' style='" + download_btn_style + "' data-max-downloads='" + product_file.max_download_count + "' data-current-downloads='" + product_file.current_download_count + "' data-limit-reached-text='" + data.btn_download_limit_reached_text + "'>" + data.btn_download_text + "</a></td></tr>");
                                            }
                                        }

                                    } else if (data.btn_show_mode == 1) {

                                        if (product_file.added_method == "url") {
                                            tr_lines[tr_index_to_append].insertAdjacentHTML("afterend", "<tr><td style='padding-top: 5px;text-align:left;' colspan='6'><a class='btn-act-download edp-btn-download' target='_blank' href='" + download_url + "' style='color: #197bbd !important; font-weight: 400;' data-max-downloads='" + product_file.max_download_count + "' data-current-downloads='" + product_file.current_download_count + "' data-limit-reached-text='" + data.btn_download_limit_reached_text + "'>" + product_file.download_link + "</a></td></tr>");
                                        } else {


                                            tr_lines[tr_index_to_append].insertAdjacentHTML("afterend", "<tr><td style='padding-top: 5px;text-align:left;' colspan='6'><a class='btn-act-download edp-btn-download' target='_blank' href='" + download_url + "' data-max-downloads='" + product_file.max_download_count + "' data-current-downloads='" + product_file.current_download_count + "' data-limit-reached-text='" + data.btn_download_limit_reached_text + "'>https://" + download_url + "</a></td></tr>");

                                        }

                                    }

                                }

                            }

                            // Show the custom text if we have one
                            if (product_file.custom_download_text && product_file.custom_download_text != "") {

                                tr_lines[tr_index_to_append].insertAdjacentHTML("afterend", "<tr><td style='padding-top: 5px;text-align:left;' colspan='6'><blockquote class='edp-short-description-text'>" + linkify(product_file.custom_download_text.replace(new RegExp('\r?\n', 'g'), '<br />')) + "</blockquote></td></tr>");

                            }

                        }

                    }

                }

            } else if (data.download_not_allowed) {

                if (data.download_not_allowed == 1) {

                    var download_not_allowed_financial_status = data.download_not_allowed_financial_status;

                    var product_table = document.querySelector(".product-table");

                    if (download_not_allowed_financial_status == "pending") {

                        var custom_order_msg = "";

                        custom_order_msg += "<div style='border: 1px solid #b8daff; margin-top: 14px; postion: relative; color: #004085; background-color: #cce5ff; border-color: #b8daff; text-align: center; position: relative; padding: 1.1rem 1.15rem; line-height: 16px; margin-bottom: 26px; border: 1px solid #b8daff; border-radius: .25rem;'>";
                        custom_order_msg += "<div style=''><span style='font-weight:bold;display:inline-block;margin-bottom:5px;'>" + data.pending_payment_text + "</span></div>";
                        custom_order_msg += "</div>";

                        product_table.insertAdjacentHTML("beforebegin", custom_order_msg);

                    } else if (download_not_allowed_financial_status == "partially_refunded") {

                        var custom_order_msg = "";

                        custom_order_msg += "<div style='border: 1px solid #b8daff; margin-top: 14px; postion: relative; color: #004085; background-color: #cce5ff; border-color: #b8daff; text-align: center; position: relative; padding: 1.1rem 1.15rem; line-height: 16px; margin-bottom: 26px; border: 1px solid #b8daff; border-radius: .25rem;'>";
                        custom_order_msg += "<div style=''><span style='font-weight:bold;display:inline-block;margin-bottom:5px;'>Downloads not available</span><br>Your downloads are not available because your order is marked as refunded or partially refunded.</div></div>";
                        custom_order_msg += "</div>";

                        product_table.insertAdjacentHTML("beforebegin", custom_order_msg);

                    }

                }

            } else if (data.has_fraud) {

                var product_table = document.querySelector(".product-table");

                var custom_order_msg = "";

                custom_order_msg += "<div style='border: 1px solid #f5c6cb; margin-top: 14px; postion: relative; color: #721c24; background-color: #f8d7da; text-align: center; position: relative; padding: 1.1rem 1.15rem; line-height: 16px; margin-bottom: 26px;  border-radius: .25rem;'>";
                custom_order_msg += "<div style=''><span style='font-weight:bold;display:inline-block;'>" + data.fraud_text + "</div></div>";
                custom_order_msg += "</div>";

                product_table.insertAdjacentHTML("beforebegin", custom_order_msg);

            }

        }

        /**
         * Checks if the script is currently running on a my_account page
         */
        function onMyAccountPage() {

            const path = window.location.pathname;
            // The pathname most likely looks like /collections/something/products/product-handle
            const potentialHandle = path.substring(path.lastIndexOf("/") + 1);

            if (potentialHandle == "account") {
                return true;
            } else {
                return false;
            }

        }

    }

})();